name: Auto-approve PRs (bot)

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  # The job will use the BOT_TOKEN secret; github-script will authenticate using that
  # We still set minimal default permissions for the GITHUB_TOKEN.
  pull-requests: read

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-approve with bot token
        uses: actions/github-script@v7
        with:
          # Use the bot PAT stored as a repository secret
          github-token: ${{ secrets.BOT_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info("No pull_request payload found; exiting.");
              return;
            }

            const prNumber = pr.number;
            const prAuthor = pr.user.login;
            const prDraft   = pr.draft === true;

            // Get the authenticated user for the token (bot user)
            const authUser = (await github.rest.users.getAuthenticated()).data.login;
            core.info(`Authenticated as: ${authUser}`);

            if (prDraft) {
              core.info(`PR #${prNumber} is a draft; skipping auto-approve.`);
              return;
            }

            if (prAuthor === authUser) {
              core.info(`PR author is the bot (${authUser}); skipping auto-approve to avoid self-approval loops.`);
              // If you DO want the bot to approve PRs created by the human who invited the bot (i.e. bot is not the PR author), the above is safe.
              return;
            }

            // Optionally require a label to trigger auto-approve.
            // Uncomment the following block to require label "auto-approve".
            /*
            const labels = pr.labels.map(l => l.name);
            if (!labels.includes("auto-approve")) {
              core.info("Label 'auto-approve' not present; skipping auto-approve.");
              return;
            }
            */

            // Avoid double-approving: check if bot already submitted a review
            const reviewsResp = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            const reviews = reviewsResp.data || [];
            const alreadyReviewed = reviews.some(r => r.user && r.user.login === authUser && (r.state === "APPROVED" || r.state === "COMMENTED" || r.state === "CHANGES_REQUESTED"));

            if (alreadyReviewed) {
              core.info(`Bot ${authUser} already reviewed PR #${prNumber}; skipping duplicate approval.`);
              return;
            }

            // Optional guard: only approve if CI checks are passing
            // Uncomment to enable: the code checks combined status for the head SHA
            /*
            const checkRuns = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha,
            });
            const concludedFailure = checkRuns.data.check_runs.some(cr => cr.conclusion && cr.conclusion !== "success" && cr.conclusion !== "neutral");
            if (concludedFailure) {
              core.info("One or more check runs failed or were inconclusive; skipping auto-approve.");
              return;
            }
            */

            // Create approval review
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              event: "APPROVE",
              body: "Auto-approved by repository bot."
            });
            core.info(`Created APPROVE review for PR #${prNumber} by ${authUser}.`);
