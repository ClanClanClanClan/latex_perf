name: Proof Gate - Zero Admits Policy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]


concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true


jobs:
  proof-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - uses: ./.github/actions/setup-ocaml
      with:
        ocaml-compiler: 4.14.1
        opam-depext: false
    - name: Install Coq toolchain
      run: |
        opam repo add default https://opam.ocaml.org || true
        opam repo add coq-released https://coq.inria.fr/opam/released || true
        opam update -y
        opam install -y dune coq.8.18.0 coq-core.8.18.0 coq-mathcomp-ssreflect.1.17.0

    - name: Check _CoqProject exists
      run: |
        if [ ! -f "_CoqProject" ]; then
          echo "❌ _CoqProject file missing - Week 5 requirement"
          exit 1
        fi
        echo "✅ _CoqProject found"

    - name: Build Coq proofs
      run: |
        opam exec -- dune build proofs

    - name: Check for admits
      run: |
        ADMITS=$(grep -rE "\\bAdmitted\\.|\\badmit\\." --include="*.v" --exclude-dir=archive --exclude='*.disabled' proofs/ | wc -l || true)
        echo "Found $ADMITS admits in proof files"
        if [ "$ADMITS" -ne 0 ]; then
          echo "❌ Zero‑admit policy violated"
          grep -rE "\\bAdmitted\\.|\\badmit\\." --include="*.v" --exclude-dir=archive --exclude='*.disabled' proofs/ | head -50 || true
          exit 1
        fi
        echo "✅ Zero admits"

    - name: Check for axioms
      run: |
        AXIOMS=$(grep -r "^Axiom\>\|^Parameter\>.*:" --include="*.v" proofs/ | wc -l || true)
        echo "Found $AXIOMS axioms in proof files"
        if [ "$AXIOMS" -ne 0 ]; then
          echo "❌ Axiom‑free policy violated"
          grep -r "^Axiom\>\|^Parameter\>.*:" --include="*.v" proofs/ | head -50 || true
          exit 1
        fi
        echo "✅ Zero axioms"

    - name: Verify proof completeness
      run: |
        echo "✅ Proof gate PASSED (zero admits, zero axioms, build SUCCESS)"
