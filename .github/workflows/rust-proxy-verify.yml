name: Rust Proxy Verify (evidence)

on:
  schedule:
    - cron: '30 3 * * *'
  workflow_dispatch:
  push:
    branches: [ main, develop ]


concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true


jobs:
  rust-proxy-verify:
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-ocaml
        with:
        ocaml-compiler: 5.1.1
          opam-depext: false
      - name: Install dune and deps
        run: |
          opam repo add default https://opam.ocaml.org || true
          opam update -y
          opam install -y . --deps-only --with-test

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Build OCaml service and Rust proxy
        run: |
          opam exec -- dune build latex-parse/src/main_service.exe
          cargo build --manifest-path rust/Cargo.toml -p elderd_rust_proxy --release

      - name: Run verify_r1 (proxy A/B perf gate)
        run: |
          make verify_r1 FILE=corpora/perf/perf_smoke_big.tex

      - name: Upload verify artifacts (best-effort)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rust-proxy-verify
          path: |
            /tmp/ab_microbench_*.csv
            /tmp/edit_window_bench_*.csv
