name: Week 1 Validation Pipeline
# LaTeX Perfectionist v25 - CI/CD Setup

on:
  push:
    branches: [ main, dfa-prototype ]
  pull_request:
    branches: [ main ]


concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true


jobs:
  coq-compilation:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup OCaml
      uses: ./.github/actions/setup-ocaml
      with:
        ocaml-compiler: 4.14.x
        opam-depext: false
    - name: Install Coq toolchain
      run: |
        opam repo add default https://opam.ocaml.org || true
        opam repo add coq-released https://coq.inria.fr/opam/released || true
        opam update
        opam install --yes coq.8.18.0 coq-mathcomp-ssreflect.1.17.0

    - name: Build core proof suite
      run: |
        eval $(opam env)
        coqc -Q proofs LaTeXPerfectionist proofs/Catcode.v
        coqc -Q proofs LaTeXPerfectionist proofs/CoreProofs.v
        coqc -Q proofs LaTeXPerfectionist proofs/LexerFaithfulStep.v
        coqc -Q proofs LaTeXPerfectionist proofs/LexerSmallstep.v
        coqc -Q proofs LaTeXPerfectionist proofs/LexerTotality.v

  admit-audit:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Count Admits
      run: |
        ADMIT_COUNT=$(find proofs -name "*.v" ! -name "*.disabled" -exec grep -c "Admitted\|admit" {} \; | awk '{sum += $1} END {print sum}')
        echo "Total admits found: $ADMIT_COUNT"

        # Week 1 target: maintain ≤60 admits
        if [ "$ADMIT_COUNT" -gt 60 ]; then
          echo "❌ FAIL: Too many admits ($ADMIT_COUNT > 60)"
          echo "Week 1 target is to maintain ≤60 admits while adding new functionality"
          exit 1
        else
          echo "✅ PASS: Admit count within target ($ADMIT_COUNT ≤ 60)"
        fi

    - name: Check for Axioms
      run: |
        AXIOM_COUNT=$(find proofs -name "*.v" ! -name "*.disabled" -exec grep -c "^Axiom" {} \; | awk '{sum += $1} END {print sum}')
        echo "Total axioms found: $AXIOM_COUNT"

        if [ "$AXIOM_COUNT" -gt 0 ]; then
          echo "❌ FAIL: Axioms found ($AXIOM_COUNT)"
          echo "v25 specification requires zero axioms"
          exit 1
        else
          echo "✅ PASS: No axioms found"
        fi

  ocaml-compilation:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup OCaml
      uses: ./.github/actions/setup-ocaml
      with:
        ocaml-compiler: 4.14.x
        opam-depext: false
    - name: Install project dependencies
      run: |
        opam update
        opam install --yes dune yojson angstrom uutf ppx_deriving

    - name: Build latex-parse components
      run: |
        eval $(opam env)
        dune build --root latex-parse

    - name: Validator CLI smoke test
      run: |
        eval $(opam env)
        TEX_SAMPLE="$PWD/corpora/l1/CMD-001_deprecated_after_expansion.tex"
        dune exec --root latex-parse -- src/validators_cli.exe --layer l1 "$TEX_SAMPLE" > /tmp/validator.out
        grep "CMD-001" /tmp/validator.out

  performance-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup OCaml
      uses: ./.github/actions/setup-ocaml
      with:
        ocaml-compiler: 4.14.x
        opam-depext: false
    - name: Basic Performance Test
      run: |
        eval $(opam env)
        echo "Week 1 performance targets:"
        echo "- Catcode lookup: <1μs per character"
        echo "- Brace matching: <10μs per 1KB text"
        echo "- Whitespace normalization: <5μs per 1KB text"
        echo ""
        echo "Full performance testing will be implemented in Week 2"
        echo "✅ Performance framework ready"

  documentation-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check Documentation
      run: |
        echo "Checking Week 1 documentation requirements..."

        # Check for required files
        [ -f "latex-parse/src/catcode.ml" ] && echo "✅ latex-parse/src/catcode.ml exists"
        [ -f "proofs/Catcode.v" ] && echo "✅ proofs/Catcode.v exists"
        [ -f "docs/PROJECT_INDEX.md" ] && echo "✅ docs/PROJECT_INDEX.md exists"
        [ -f "docs/WEEKLY_STATUS.md" ] && echo "✅ docs/WEEKLY_STATUS.md exists"

        # Check for Week 1 completion markers
        if grep -q "Week 1" docs/PROJECT_INDEX.md docs/WEEKLY_STATUS.md; then
          echo "✅ Week 1 completion markers found"
        else
          echo "⚠️  Week 1 completion markers not found"
        fi

        echo "Documentation check complete"
