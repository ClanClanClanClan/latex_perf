name: Week 1 Validation Pipeline
# LaTeX Perfectionist v25 - CI/CD Setup

on:
  push:
    branches: [ main, dfa-prototype ]
  pull_request:
    branches: [ main ]


concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true


jobs:
  coq-compilation:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup OCaml
      uses: ./.github/actions/setup-ocaml
      with:
        ocaml-compiler: 5.1.1
        opam-depext: false
    - name: Install Coq toolchain
      run: |
        opam repo add default https://opam.ocaml.org || true
        opam repo add coq-released https://coq.inria.fr/opam/released || true
        for attempt in 1 2 3; do
          opam update -y && opam install -y coq.8.18.0 coq-mathcomp-ssreflect.1.17.0 && break
          echo "[week1-validation-coq] opam install failed (attempt $attempt), retrying in 15s..."
          sleep 15
        done

    - name: Build core proof suite
      run: |
        eval $(opam env)
        coqc -Q proofs LaTeXPerfectionist proofs/Catcode.v
        coqc -Q proofs LaTeXPerfectionist proofs/CoreProofs.v
        coqc -Q proofs LaTeXPerfectionist proofs/LexerFaithfulStep.v
        coqc -Q proofs LaTeXPerfectionist proofs/LexerSmallstep.v
        coqc -Q proofs LaTeXPerfectionist proofs/LexerTotality.v

  admit-audit:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Count Admits
      run: |
        ADMIT_COUNT=$(find proofs -name "*.v" ! -name "*.disabled" -exec grep -c "Admitted\|admit" {} \; | awk '{sum += $1} END {print sum}')
        echo "Total admits found: $ADMIT_COUNT"

        # Week 1 target: maintain ≤60 admits
        if [ "$ADMIT_COUNT" -gt 60 ]; then
          echo "❌ FAIL: Too many admits ($ADMIT_COUNT > 60)"
          echo "Week 1 target is to maintain ≤60 admits while adding new functionality"
          exit 1
        else
          echo "✅ PASS: Admit count within target ($ADMIT_COUNT ≤ 60)"
        fi

    - name: Check for Axioms
      run: |
        AXIOM_COUNT=$(find proofs -name "*.v" ! -name "*.disabled" -exec grep -c "^Axiom" {} \; | awk '{sum += $1} END {print sum}')
        echo "Total axioms found: $AXIOM_COUNT"

        if [ "$AXIOM_COUNT" -gt 0 ]; then
          echo "❌ FAIL: Axioms found ($AXIOM_COUNT)"
          echo "v25 specification requires zero axioms"
          exit 1
        else
          echo "✅ PASS: No axioms found"
        fi

  ocaml-compilation:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup OCaml
      uses: ./.github/actions/setup-ocaml
      with:
        ocaml-compiler: 5.1.1
        opam-depext: false
    - name: Install project dependencies
      run: |
        opam repo add default https://opam.ocaml.org || true
        for attempt in 1 2 3; do
          opam update -y && opam install -y dune yojson angstrom uutf ppx_deriving && break
          echo "[week1-validation-ocaml] opam install failed (attempt $attempt), retrying in 15s..."
          sleep 15
        done

    - name: Build latex-parse components
      run: |
        eval $(opam env)
        dune build --root latex-parse

    - name: Validator CLI smoke test
      run: |
        eval $(opam env)
        TEX_SAMPLE="$PWD/corpora/l1/CMD-001_deprecated_after_expansion.tex"
        dune exec --root latex-parse -- src/validators_cli.exe --layer l1 "$TEX_SAMPLE" > /tmp/validator.out
        grep "CMD-001" /tmp/validator.out

