# GitHub Actions Failure Brief – Runs 46975490661 (build) & 46975490606 (rust-proxy-smoke)

## Scope & Context
- **Relevant commit:** `1bfedc4070c73f3fe3b703c4590587e44b7d9eed` (merge of `5450d255c57125146bf07667c16adde094b0ae88` into `92bdfe28e9a19447735918ce6f6c8395415acf11`).
- **Runner environment:** `ubuntu-22.04` image `20250929.88.1`, runner version `2.328.0`. Details in `logs_46975490661.zip/0_build.txt` (lines 1-30).
- **Artifacts analysed:**
  - `/Users/dylanpossamai/Downloads/logs_46975490661.zip`
  - `/Users/dylanpossamai/Downloads/logs_46975490606.zip`
- **Sandboxing state:** Job-level `OPAMNO_SANDBOXING=1` plus explicit disable step; no residual `bwrap` errors observed in either run.
- **Caches:** Multiple `actions/cache` restores failed with HTTP 400 (non-fatal, increase install time only).

## Failure A – Coq build in `build` workflow (Run 46975490661)

### Command sequence
1. `opam exec -- coq_makefile -f _CoqProject -o CoqMakefile`
2. `opam exec -- make -f CoqMakefile -j2`
3. `rm -f CoqMakefile CoqMakefile.conf .CoqMakefile.d`
4. `pushd latex-parse >/dev/null`
5. `opam exec -- dune build`
6. `popd >/dev/null`
7. `opam exec -- dune build @all` *(not reached)*

Commands 1–6 are logged in `build/5_Build.txt` (timestamps `2025-10-06T07:57:18Z` onward).

### Observed warnings
- Repeated `Warning: Cannot open generator [cannot-open-path,filesystem,default]` while compiling multiple `.v` files. These originate from Coq plugin discovery attempts and do **not** stop execution.

### Hard failure
- Coq halts compiling `proofs/LexerSoA.v` with:
  ```
  File "./proofs/LexerSoA.v", line 184, characters 13-15:
  Error: ks is already used.
  ```
  Logged at `2025-10-06T07:57:19Z` in `build/5_Build.txt`.
- `make[1]` aborts target `proofs/LexerSoA.vo`, deletes `proofs/LexerSoA.glob`, and the overall `make` exits with code 2 before the queued `dune build` commands execute.

### Local source snapshot (for reference)
Current lemma (see repository `proofs/LexerSoA.v:179-189`):
```coq
Lemma run_from_app : forall ks os cs i1 i2,
  run_from ks os cs (i1 ++ i2) =
  let '(ks1,os1,cs1) := run_from ks os cs i1 in run_from ks1 os1 cs1 i2.
Proof.
  induction i1 as [|b rest IH].
  - intros ks os cs i2; simpl; reflexivity.
  - intros ks os cs i2; simpl.
    specialize (IH (ks ++ [classify_kind b])
                  (os ++ [length ks])
                  (cs ++ [classify_code b]) i2).
    exact IH.
Qed.
```
`intros ks` clashes with the binder already introduced by `induction i1`, causing the "already used" error. Proof never progresses to `rewrite` or destructuring.

### Immediate follow-up items for expert
- Resolve naming conflict in `run_from_app` proof (e.g., rename intro variables or generalize before induction). Re-run `opam exec -- make -f CoqMakefile -j2` to verify.
- Optional: Investigate Coq generator warnings if they hint at missing plugins (likely benign).

## Failure B – Smoke test in `rust-proxy-smoke` workflow (Run 46975490606)

### Pipeline state prior to failure
- Steps `Install dune`, `Setup Rust`, `Build service and proxy`, and `Start service and proxy` all succeeded. Build logs show `dune` and `cargo` compiling successfully.
- Services were launched: `main_service.exe` and `elderd_rust_proxy` PIDs stored in `service.pid`/`proxy.pid` (see `rust-proxy-smoke/8_Start service and proxy.txt`).

### Failing step
- Step `Smoke 3 requests via proxy` runs `python3 scripts/proxy_smoke.py` (`rust-proxy-smoke/9_Smoke 3 requests via proxy.txt`).
- Output at `2025-10-06T07:59:33Z`:
  ```
  [proxy-smoke] request 2 returned status=1, tokens=0, issues_len=0, origin=1
  status nonzero: 1
  Process completed with exit code 1.
  ```
- Request 1 (and possibly 3) produce no log entries, implying failure occurs on the second query. The script exits immediately with code 1, marking the job failed.

### Environment snapshot
- `OPAMNO_SANDBOXING=1` exported both as job-level env and via the dedicated step. `cargo` build logs confirm the variable is visible during execution.

### Unknowns & diagnostic gaps
- Root cause of status code 1 is not evident: no HTTP response details or server logs captured. Services’ stdout/stderr are not persisted in the workflow.
- Proxy script does not currently emit the request payload, endpoint, or error response, limiting observability.

### Suggested next steps
1. Instrument `scripts/proxy_smoke.py` to log request URLs, response status, and body when a non-zero status occurs.
2. Capture service logs: launch `main_service.exe` and `elderd_rust_proxy` under `tee` or redirect output to files uploaded as workflow artifacts.
3. Re-run smoke test locally (after successful Coq build) to reproduce and inspect logs interactively.

## Additional Notes
- Cache restore warnings (`actions/cache` 400 responses) appear in both pipelines but are non-blocking.
- Disabling sandboxing resolved all prior `bwrap` failures; no further action required there.
- CI is running on a merge commit produced by GitHub. Local branches should be rebased or aligned with this merge before attempting fixes.
- Ensure the expert has access to the referenced log archives and ability to run:
  ```bash
  opam exec -- make -f CoqMakefile -j2
  python3 scripts/proxy_smoke.py
  ```
  after starting the OCaml service and Rust proxy binary locally.

