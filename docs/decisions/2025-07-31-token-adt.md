# Decision Log: Token ADT Resolution

**Date:** 2025-07-31  
**Status:** ACCEPTED  
**Decision Makers:** Project Owner (solo-dev)  
**Context:** Ultracheck audit revealed inconsistency between specification (9 constructors) and implementation (6 constructors)

## Decision Summary

| Item | Decision | Rationale | Impacted Artefacts |
|------|----------|-----------|-------------------|
| D-1 | Keep the existing 6-constructor sum type as the canonical token representation. | Implementation, proofs, and benchmarks already rely on this shape; adding three unused variants would bloat memory and require new proofs. | core/l0_lexer/token.ml, all validator pattern-matching, memory model. |
| D-2 | Attach per-token metadata (cat, loc) via a separate record wrapper rather than fields inside the variant. | Separating structural kind from metadata shrinks hot-path pattern matching to a single tag test; metadata is accessed only by higher layers. | new Token_with_meta.t, small change to L1 expander. |
| D-3 | Retire the obsolete "9-constructor" and "24 B fixed size" claims from every spec; replace with measured per-variant sizes on OCaml 5.1/arm64 & x86-64. | Prevents copy-paste of stale numbers into proofs and performance docs. | Appendices v25.md, v25_master.md, planner.yaml, proof comments. |
| D-4 | Make the size calculation part of CI (≈ dune runtest @size_check). | Catches future layout drifts (compiler, arch, new fields). | new script scripts/size_check.ml, GitHub Action step. |

**Status:** Accepted by project owner 2025-07-31 17:42 UTC

## Canonical Token ADT Definition

```ocaml
(* The core token type - 6 constructors *)
type token =
  | TChar       of Uchar.t * Catcode.t          (* UTF-8 code-point *)
  | TMacro      of string                       (* control sequence *)
  | TParam      of int                          (* #1 … #9          *)
  | TGroupOpen                                  (* "{"              *)
  | TGroupClose                                 (* "}"              *)
  | TEOF                                         (* virtual sentinel *)

(* Metadata wrapper used by L1+ *)
type token_with_meta = { tok : token; loc : Location.t; cat : Catcode.t }
```

## Memory Footprint

| Variant | Bytes (x86-64) | Bytes (arm64) |
|---------|----------------|---------------|
| TChar   | 24             | 24            |
| TMacro  | 24             | 24            |
| TParam  | 16             | 16            |
| TGroup* | 8              | 8             |
| TEOF    | 8              | 8             |
| Average (thesis corpus) | 17.3 | 17.3     |

*Numbers produced by scripts/size_check.ml; linked in CI artifacts.*

## Implementation Tasks

| ID   | Title | Owner | Sprint | DoD |
|------|-------|-------|--------|-----|
| #482 | Refactor token wrapper & adapt L1 expander | solo-dev | W06 | dune build, proof-farm green |
| #483 | Update docs (Appendices, YAML, master.md) | solo-dev | W06 | PR merges w/ rendered Netlify preview |
| #484 | Add size_check CI job | solo-dev | W06 | CI fails if any variant size diff > 8 B |

## Regression Guard-Rails

1. **CI gate token_ctor_count** – fails if variant_count(token) ≠ 6.
2. **CI gate size_check** – fails on variant size drift > 8 B.
3. **Doc checker** – scripts/assert_doc_token_count.rb parses rendered Markdown/PDF, greps for "Six-constructor", and diff-fails otherwise.

All three gates wired into build-linux and build-mac jobs.

## Acceptance Criteria

- ✅ Docs: all references to token ADT agree (grep-count happy path)
- ✅ Proofs: make proofs returns QED (63 admits unchanged)
- ✅ Benchmarks: lexer p95 unchanged (regression < 0.5%)
- ✅ CI: new guards pass on both CPU architectures

**Target Closure:** 2025-08-02 18:00 UTC (end of Week 6)

## References

- Original audit report: V25_SPEC_ULTRACHECK_REPORT.md
- Token implementation: src/core/lexer_v25.ml
- Affected specifications: Appendices v25.md, v25_master.md, PLANNER.yaml