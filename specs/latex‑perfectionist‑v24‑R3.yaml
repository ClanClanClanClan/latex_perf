# ======================================================================
#  latex‑perfectionist‑v24‑R3.yaml
#  Architecture & project plan
#  Complementary file: rules.yaml  (542 rule definitions)
# ======================================================================

metadata:
  project: "latex-perfectionist"
  revision: "v24-R3"
  commit_id: "2025-07-13-v24-R3"
  previous_revision: "v24-R2"
  spec_generated: "2025-07-13T23:59:00Z"

# ----------------------------------------------------------------------
#  0. Road‑map  (adjusted per audit)
# ----------------------------------------------------------------------
roadmap:
  milestones:
    - month: 1-2
      deliverable: "Layer‑01 verified lexer (done)"
      proof_targets: ["lexer_deterministic"]
      user_value: "internal only"
    - month: 3-4
      deliverable: "Layer‑02 verified macro expander"
      proof_targets:
        - "expand_fuel_insensitive"
        - "expand_terminates_acyclic"
        - "expand_no_teof"
      user_value: "Phase 1½ rules enabled"
    - month: 5
      deliverable: "Phase 1 – lexical rules"
      proof_targets: ["rule_sound (70 rules)"]
      user_value: "real‑time lexical lint"
    - month: 6
      deliverable: "CI translation‑validation harness"
      proof_targets: []
      user_value: "zero‑FP guarantee vs. pdfTeX"
    - month: 7-9
      deliverable: "Layer‑03 PEG parser + proofs"
      proof_targets: ["parse_sound"]
      user_value: "Phase 2 rules (structural)"
    - month: 10
      deliverable: "Layer‑04 reference interpreter"
      proof_targets: ["interp_preserves_tokens"]
      user_value: "Phase 3 semantic rules"
    - month: 11
      deliverable: "Phase 4 style rules"
      proof_targets: []          # optional proofs
      user_value: "document‑wide consistency"
    - month: 12
      deliverable: "Enterprise release: Verified Build 1.0"
      proof_targets: ["no_false_positives_epsilon"]
      user_value: "deterministic binary stamp"

# ----------------------------------------------------------------------
#  1. LaTeX 𝜖  (verified subset contract)
# ----------------------------------------------------------------------
latex_epsilon:
  classes:
    permitted: ["article", "amsart", "amsbook"]
    frozen_ctan_date: "2025-03-31"
  packages:
    permitted:
      - "amsmath"
      - "amsfonts"
      - "graphicx"
      - "hyperref"
      - "biblatex"
      - "mathtools"
      - "geometry"
      - "microtype"
      - "cleveref"
      - "xcolor"
      - "csquotes"
      - "siunitx"
      - "tikz"
      - "pgfplots"
      - "url"
      - "latexdiff"
    manifest_file: "manifest/latex-epsilon.lock"
  macros:
    allowed_primitives: ["\\newcommand", "\\renewcommand"]
    constraints:
      - "optional_args = 0"
      - "acyclic_bodies = true"
      - "no_conditionals = true"
      - "no_loop_primitives = true"
    fuel_limits:
      token_growth: 8_192          # hard cap on total tokens
      macro_calls: 512             # depth **and** count
  catcodes:
    allowed: "local group‑scoped changes only"
  verbatim_handling:
    token_type: "TVerbatim"
    lexer_behavior: "merge entire region into single token"
  engine:
    binary: "pdfTeX 1.40.26"
    container_sha256: "b68d…(full 256‑bit hash)"
  io_policy:
    read_scope: "workspace‑relative *.tex"
    forbidden: ["shell_escape", "write18", "network"]
  fallback:
    on_perimeter_violation: "classic TeX compile"
    ui_badge: "yellow_shield"
    telemetry: "hashed package name only (GDPR‑safe)"

# ----------------------------------------------------------------------
#  2. Verified layer stack
# ----------------------------------------------------------------------
layers:
  - id: L0
    name: "Lexer"
    interface: "list<char> → list<token>"
    proofs: ["lexer_deterministic"]
  - id: L1
    name: "Macro‐expander"
    interface: "expand : fuel nat × token list → option token list"
    proofs:
      - "expand_fuel_insensitive"
      - "expand_terminates_acyclic"
      - "expand_no_teof"
    termination_measure: "fuel ↓ && macro_calls ≤ 512"
  - id: L2
    name: "PEG parser"
    interface: "token list → ast"
    depends_on: [L1]
    proofs: ["parse_sound"]
  - id: L3
    name: "Reference interpreter"
    interface: "ast → semantic_state"
    depends_on: [L2]
    proofs: ["interp_preserves_tokens"]
  - id: L4
    name: "Validation layers (rule engine)"
    depends_on: [L0, L1, L2, L3]

# ----------------------------------------------------------------------
#  3. Validation phases
# ----------------------------------------------------------------------
phases:
  - idx: 1
    name: "Lexical"
    runs_after: L0
    rule_families: "TYPO, ENC, CHAR, SPC, VERB"
    rule_count: 72
  - idx: 1.5
    name: "Post‑expansion"
    runs_after: L1
    rule_families: "DELIM, MATH (0‑40), REF, SCRIPT (<=010), CMD"
    rule_count: 80
  - idx: 2
    name: "Structural"
    runs_after: L2
    rule_families: "STRUCT, TAB, FIG, PKG basic"
    rule_count: 200
  - idx: 3
    name: "Semantic"
    runs_after: L3
    rule_families: "LAY, BIB, PKG advanced, ACCESS, TIKZ runtime"
    rule_count: 150
  - idx: 4
    name: "Style"
    runs_after: L4
    rule_families: "STYLE, LANG, DOC"
    rule_count: 40

# ----------------------------------------------------------------------
#  4. Rule registry schema  (synchronised with rules.yaml)
# ----------------------------------------------------------------------
registry_schema:
  severity_enum: ["Error", "Warning", "Info"]
  maturity_enum: ["Draft", "Stable", "Proven"]
  performance_bucket_enum:
    - "TokenKind_Text"
    - "TokenKind_Command"
    - "TokenKind_MathShift"
    - "TokenKind_BeginGroup"
    - "TokenKind_EndGroup"
    - "TokenKind_Other"
  record:
    id: "string"
    description: "string"
    precondition: "layer"
    default_severity: "severity_enum"
    maturity: "maturity_enum"
    owner: "github_handle"
    performance_bucket: "performance_bucket_enum"
    fix: "string | null"
    validator: "document_state → list validation_issue"
    rule_sound: "proof_ref | null"
    implementation: "path/to/coq_file.v"

# ----------------------------------------------------------------------
#  5. Engineering
# ----------------------------------------------------------------------
engineering:
  executor:
    single_pass: true
    purity_requirement: "validator must be pure / total"
  repo_layout:
    src/core: ["lexer", "expander", "parser", "interp"]
    src/rules: ["phase1", "phase1½", "phase2", "phase3", "phase4"]
    engine/pdftex-bin: "frozen binary + sha file"
    tests/corpus: 500
    tests/adversarial: 20
    manifest: ["latex-epsilon.lock"]
  ci_pipeline:
    image: "alpine:3.19 + Coq 8.20"
    steps:
      - build: "dune build @check"
      - verify_rules: "./scripts/registry_check.sh rules.yaml"
      - translation_validation: |
          for f in tests/corpus/*.tex tests/adversarial/*.tex; do
            ./bin/verifier "$f" || exit 1
            pdftex -no-shell-escape -interaction=nonstopmode "$f" >/dev/null || exit 1
          done
  telemetry:
    data: ["package_hash", "rule_ids_triggered", "compile_time_ms"]
    pii_policy: "no document text, anonymised project ID"

# ----------------------------------------------------------------------
#  6. Governance
# ----------------------------------------------------------------------
governance:
  maturity_policy:
    stable_threshold: "≤0.1 % empirical FP on 1 000‑doc nightly run"
    dataset: "tests/corpus + random arXiv sample"
  ctan_bot:
    schedule: "weekly"
    action: "opens PR with diff; requires human sign‑off"
  escalation:
    security_patch_window: "24 h"
  license:
    code: "MIT"
    third_party:
      - path: "engine/pdftex-bin"
        license: "GPL‑2+"
      - path: "packages/*"
        license: "LPPL or per‑package"

# ----------------------------------------------------------------------
#  7. Verification promise matrix
# ----------------------------------------------------------------------
verification_promises:
  - property: "compiles under frozen tool‑chain"
    guarantee: "Proof: no_false_positives_epsilon"
    layer_required: ["L0","L1","L2","L3"]
  - property: "lexical error markers (Phase 1)"
    guarantee: "Proof per rule"
    layer_required: ["L0"]
  - property: "delimiter / math func / ref checks"
    guarantee: "Proof per rule (post‑expansion)"
    layer_required: ["L1"]
  - property: "AST warnings"
    guarantee: "Empirical ≤1 % FP until proofs complete"
    layer_required: ["L2"]
  - property: "semantic & style suggestions"
    guarantee: "Best‑effort"
    layer_required: ["L3","L4"]

# ----------------------------------------------------------------------
#  8. Next‑action table  (updated dates)
# ----------------------------------------------------------------------
next_actions:
  - week: 4.1
    action: "ValidationTypes.v + executor scaffold"
    owner: "@core-dev"
    artifact: "merge req #42"
  - week: 4.2
    action: "Implement 10 lexical rules + proofs"
    owner: "@lint-team"
    artifact: "rules/phase1/"
  - week: 4.3
    action: "latex‑epsilon.lock generator"
    owner: "@releng"
    artifact: "manifest/"
  - week: 4.4
    action: "CI pipeline incl. pdfTeX docker (no shell‑escape)"
    owner: "@ci-maint"
  - week: 5.1
    action: "Finish verified expander & proofs"
    owner: "@core-dev"
  - week: 5.2
    action: "Phase 1½ rule implementation"
    owner: "@lint-team"
  - week: 7-9
    action: "PEG grammar + parser proofs"
    owner: "@parser-squad"

# ----------------------------------------------------------------------
#  9. Patch history
# ----------------------------------------------------------------------
patches_applied:
  - id: "R2→R3‑001"
    description: "Timeline extended for expander & parser realism"
  - id: "R2→R3‑002"
    description: "expander fuel tied to macro_calls as well as token length"
  - id: "R2→R3‑003"
    description: "lexer merges verbatim ⇒ TVerbatim token"
  - id: "R2→R3‑004"
    description: "CI removes --shell-escape and adds adversarial corpus"
  - id: "R2→R3‑005"
    description: "Phase matrix count fixed to 72 lexical rules, total 542"
  - id: "R2→R3‑006"
    description: "registry schema adds fix & performance_bucket"
  - id: "R2→R3‑007"
    description: "telemetry anonymisation note"
  - id: "R2→R3‑008"
    description: "package whitelist expanded (amsfonts, url, latexdiff)"

# ======================================================================
#  End of spec.  See companion file rules.yaml for full rule catalogue.
# ======================================================================