# ======================================================================
#  latexâ€‘perfectionistâ€‘v25.yaml           (standâ€‘alone master specification)
# ======================================================================

metadata:
  project           : "latex-perfectionist"
  revision          : "v25"
  previous_revision : "v24â€‘R3"
  commit_id         : "TBDâ€‘onâ€‘tag"
  spec_generated    : "2025â€‘08â€‘01T00:00:00Z"

# ----------------------------------------------------------------------
#  0 Â· Roadâ€‘map  (qualityâ€‘first, timeâ€‘flexible, Moonâ€‘shots in v26)
# ----------------------------------------------------------------------
roadmap:
  milestones:
    - quarter: Q1â€‘Q2Â Y1
      name   : "L1 proof completion + Tactical optimiser"
      deliverables:
        - Layerâ€‘1 proof set               # expand_fuel_insensitive,Â ...
        - Tactical bundle Tâ€‘1 â€¦Â Tâ€‘5
        - Validator count â‰¥â€¯200
      user_value: "blazingâ€‘fast lexical + postâ€‘expansion lint"

    - quarter: Q3â€‘Q4Â Y1
      name   : "Layerâ€‘2 PEG parser + 70â€¯% validator coverage"
      deliverables:
        - L2 parser (PEG) + parse_sound proof
        - 380 validators (PhaseÂ 1,Â 1Â½,Â 2)
      user_value: "structural rules with formal backing"

    - quarter: Q1â€‘Q2Â Y2
      name   : "Layerâ€‘3 interpreter + Strategic bundle"
      deliverables:
        - L3 semantic core + interp_preserves_tokens proof
        - Strategic bundleÂ Sâ€‘1,Â Sâ€‘2
        - 480 validators total
      user_value: "live crossâ€‘ref & complexity alarm"

    - quarter: Q3â€‘Q4Â Y2
      name   : "Full v25 compliance"
      deliverables:
        - 542 validators proven
        - Proofâ€‘carrying plugâ€‘in APIÂ (Sâ€‘3)
        - GPU coldâ€‘start prototypeÂ (Sâ€‘4) *optionalâ€‘proof*
        - CI translationâ€‘validation with pdfTeX oracle
      user_value: "enterpriseâ€‘grade zeroâ€‘FP guarantee"

    - quarter: Y3 (buffer)
      name   : "Refinement & backlog"
      deliverables:
        - debtâ€‘cleanup admitsÂ =â€¯0
        - performance p95 singleâ€‘charÂ <â€¯1â€¯ms on 3â€¯MB
        - documentation & hardening
      user_value: "rockâ€‘solid v25 LTS"

# ----------------------------------------------------------------------
#  1 Â· LaTeXÂ ğœ– v25 contract  (unchangedÂ â‰ƒÂ v24â€‘R3 except notes)
# ----------------------------------------------------------------------
latex_epsilon:
  classes          : { permitted: ["article","amsart","amsbook"]   }
  packages         : { permitted: [...]                           }  # identical list
  macros:
    allowed_primitives : ["\\newcommand","\\renewcommand"]
    constraints        :
      - optional_args   = 0
      - acyclic_bodies  = true
      - no_conditionals = true
      - no_loop_primitives = true
    fuel_limits:
      token_growth : 8_192
      macro_calls  : 512
  verbatim_handling:
    token_type     : "TVerbatim"
    lexer_behavior : "merge region into single token"
  engine:
    binary         : "pdfTeXÂ 1.40.26"
    container_sha256: "b68dâ€¦"
  fallback:
    on_perimeter_violation: "classic TeX compile"
    ui_badge: "yellow_shield"

# ----------------------------------------------------------------------
#  2 Â· Verified layer stack  (v25 targets highlighted)
# ----------------------------------------------------------------------
layers:
  - id: L0
    name : "Lexer"
    iface: "bytes â†’ list<token>"
    proofs:
      - lexer_deterministic        # done
      - incremental_equiv          # NEW (StreamChunk)
  - id: L1
    name : "Macroâ€‘expander"
    iface: "fuel Ã— token list â†’ option token list"
    proofs:
      - expand_fuel_insensitive    # to finish
      - expand_terminates_acyclic
      - expand_no_teof
  - id: L2
    name : "PEG parser"
    iface: "token list â†’ ast"
    proofs:
      - parse_sound
  - id: L3
    name : "Reference interpreter"
    iface: "ast â†’ semantic_state"
    proofs:
      - interp_preserves_tokens
  - id: L4
    name : "Validation engine"
    iface: "semantic_state â†’ list<issue>"
    proofs: []                     # perâ€‘rule proofs live in rules tree

# ----------------------------------------------------------------------
#  3 Â· Layerâ€‘internal innovation files (NEW in v25)
# ----------------------------------------------------------------------
files:
  coq/lexer/StreamChunk.v           : "lex one chunk" primitive
  coq/lexer/StateCodec.v            : encode/decode lexer_state
  coq/lexer/CheckpointTheory.v      : checkpoint semantics
  coq/lexer/IncrementalCorrect.v    : lineâ€‘table incremental proof
  coq/vsna/UVSNA.v                  : unified state machine (existing)
  coq/vsna/UVSNA_CARC.v             : CARC classification (existing)
  ocaml/runtime/incremental_lexer.ml: checkpoint cache + LRU
  ocaml/runtime/hash_xx_simd.c      : SIMD xxHash (Tâ€‘3)
  python/tests/fuzz_equiv.py        : 10â€¯M edit fuzz tester

# ----------------------------------------------------------------------
#  4 Â· Validation phases & rule counts (unchanged numerically)
# ----------------------------------------------------------------------
phases:
  - { idx: 1,   name: "Lexical",         rule_count: 72 }
  - { idx: 1.5, name: "Postâ€‘expansion",  rule_count: 80 }
  - { idx: 2,   name: "Structural",      rule_count: 200 }
  - { idx: 3,   name: "Semantic",        rule_count: 150 }
  - { idx: 4,   name: "Style",           rule_count: 40 }

# ----------------------------------------------------------------------
#  5 Â· Proof inventoryÂ (v25)
# ----------------------------------------------------------------------
proof_targets:
  mandatory:
    - lexer_deterministic                # done
    - incremental_equiv                  # StreamChunk proof
    - encode_injective                   # appendix A
    - expand_fuel_insensitive
    - expand_terminates_acyclic
    - expand_no_teof
    - parse_sound
    - interp_preserves_tokens
    - line_algo_correct                  # IncrementalCorrect
  optional:
    - gpu_equiv_kernel                   # Sâ€‘4 research
    - plugin_safety                      # Sâ€‘3 minimal lemma

# ----------------------------------------------------------------------
#  6 Â· Tactical bundle  (Tâ€‘1 â€¦Â Tâ€‘5)  â€“ timelines inside roadmap
# ----------------------------------------------------------------------
tactical_bundle:
  Tâ€‘1: prehashed_shared_cache :
        impl : ocaml/runtime/checkpoint_cache.ml
        proof: none (runtime only)
  Tâ€‘2: adaptive_chunk_size :
        proof: StreamChunk variableâ€‘length corollary (15 LOC)
  Tâ€‘3: simd_xxhash_zero_copy :
        proof: none (implementation detail)
  Tâ€‘4: snapshot_diff_api :
        interface: python/ide_adapter.py
  Tâ€‘5: early_exit_delete :
        lemma : delete_neutral_preserves_state  (12 LOC)

# ----------------------------------------------------------------------
#  7 Â· Strategic bundle (Sâ€‘1 â€¦Â Sâ€‘4)
# ----------------------------------------------------------------------
strategic_bundle:
  Sâ€‘1: macro_time_instrumentation :
        coq_file : coq/expander/MacroTime.v
        proof    : macro_time_transparent  (50 LOC)
  Sâ€‘2: live_cross_reference_index :
        ocaml    : runtime/live_index.ml
        proof    : none (uses interpreter invariants)
  Sâ€‘3: proof_carrying_plugin_api :
        coq_api  : coq/plugin/PluginAPI.v
        lemma    : plugin_safety           (60 LOC)
  Sâ€‘4: gpu_cold_start_prototype :
        status   : experimental, proof optional

# ----------------------------------------------------------------------
#  8 Â· Performance targets (v25 hardened)
# ----------------------------------------------------------------------
performance:
  cold_start_3mb_doc_ms      : 300      # with adaptive chunk + cache
  single_char_edit_ms_p95    : 1        # 3â€¯MB doc
  paragraph_paste_20_lines   : 24       # 3â€¯MB doc
  memory_footprint_3mb_doc   : "< 50 MB"
  corpus_throughput_papers_s : "â‰¥ 25"

# ----------------------------------------------------------------------
#  9 Â· CI pipeline  (freeâ€‘tier friendly)
# ----------------------------------------------------------------------
ci_pipeline:
  image           : "alpine:3.19 + Coq 8.20 + OCaml 5.2"
  steps:
    - build_coq            : "dune build @check"
    - run_fuzz_equiv       : "python3 python/tests/fuzz_equiv.py -n 2e6"
    - run_corpus_subset    : "python3 corpus/run_subset.py --limit 200"
    - bench                : "python3 python/tests/perf_bench.py --quick"
    - pdftex_validation    : "docker run pdftex-oracle ... (nightly)"
  long_running     : selfâ€‘hosted runner overnight (full corpus, long proofs)

# ----------------------------------------------------------------------
# 10 Â· Verification promise matrixÂ (v25)
# ----------------------------------------------------------------------
verification_promises:
  - property : "incrementalâ€‘vsâ€‘batch equivalence"
    guarantee: "Proof incremental_equiv"
    layers   : ["L0"]
  - property : "macro expansion fuel sound"
    guarantee: "Proof expand_fuel_insensitive"
    layers   : ["L1"]
  - property : "postâ€‘expansion validators 0â€¯FP"
    guarantee: "Perâ€‘rule proof + macro fuel"
    layers   : ["L0","L1"]
  - property : "structural / semantic accuracy â‰¤â€¯0.1â€¯% FP"
    guarantee: "Proof parse_sound, interp_preserves_tokens"
    layers   : ["L2","L3"]
  - property : "plugin safety"
    guarantee: "Proof plugin_safety (optional)"
    layers   : ["PluginAPI"]

# ----------------------------------------------------------------------
# 11 Â· Risk & mitigation  (soloâ€‘dev, high quality)
# ----------------------------------------------------------------------
risk_matrix:
  - risk : "proof fatigue"
    mitigation: "alternate coding / proving; use CoqHammer"
  - risk : "Coq version drift"
    mitigation: "pin toolchain; upgrade once per year with script"
  - risk : "performance regression"
    mitigation: "CI perf bench; fail on >10â€¯% regression"
  - risk : "pdfTeX oracle mismatch"
    mitigation: "token normaliser; manual triage weekly"
  - risk : "cache corruption"
    mitigation: "downloadable 'batch crossâ€‘check' button in IDE"

# ----------------------------------------------------------------------
# 12 Â· Appendix â€“ Formal objects (full statements)
# ----------------------------------------------------------------------
appendix:
  A_encode_injective:
    statement : |
      Lemma encode_injective :
        âˆ€ sâ‚ sâ‚‚, encode_state sâ‚ = encode_state sâ‚‚ â†’ sâ‚ = sâ‚‚.
    proof_ref : "coq/lexer/StateCodec.v"

  B_state_machine_diagram_ascii:
    diagram  : |
      (Initial)
         â”‚ read '\'
         â–¼
      +---------+
      | Command |â”€â”€â”
      +---------+  â”‚  other char
         â”‚ \n     â–¼
         â–¼     +-------+
      Comment  | Text  |
         â–²     +-------+
         â”‚ '%'          â–²
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      (Math mode subâ€‘graph elided â€“ see doc/VSNA_state.pdf)

# ======================================================================
#  End of latexâ€‘perfectionistâ€‘v25.yaml
# ======================================================================